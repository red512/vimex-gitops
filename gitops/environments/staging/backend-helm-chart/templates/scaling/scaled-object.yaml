apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: backend-scaler
  namespace: {{ .Values.namespace.name }}
spec:
  scaleTargetRef:
    apiVersion: argoproj.io/v1alpha1
    kind: Rollout
    name: celery-worker
  minReplicaCount: 1
  maxReplicaCount: 3
  pollingInterval: 15  # Check every 15 seconds
  cooldownPeriod: 60   # Wait 1 minute before scaling down
  fallback:
    failureThreshold: 3
    replicas: 1
  triggers:
    - type: redis
      metadata:
        address: "10.109.162.45:6379"
        listName: {{ .Values.autoscaling.redis.queueName | default "celery" | quote }}
        listLength: "5"
        activationListLength: "3"
        databaseIndex: "0"
        enableTLS: "false"
        scaleUp:
          amount: 1
          threshold: 10
        scaleDown:
          amount: 1
          threshold: 3